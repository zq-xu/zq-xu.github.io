import{_ as s,o as a,c as n,Q as l}from"./chunks/framework.48927342.js";const p="/images/cloud-native/kubernetes/architecture-ha-k8s-cluster.png",h=JSON.parse('{"title":"Kubernetes高可用集群安装","description":"","frontmatter":{"date":"2022-12-29T00:00:00.000Z"},"headers":[],"relativePath":"zh/cloud-native/kubernetes/installation/kubernetes-cluster-ha.md","filePath":"zh/cloud-native/kubernetes/installation/kubernetes-cluster-ha.md"}'),e={name:"zh/cloud-native/kubernetes/installation/kubernetes-cluster-ha.md"},o=l('<h1 id="kubernetes高可用集群安装" tabindex="-1">Kubernetes高可用集群安装 <a class="header-anchor" href="#kubernetes高可用集群安装" aria-label="Permalink to &quot;Kubernetes高可用集群安装&quot;">​</a></h1><p>高可用K8S集群是指K8S的Master节点个数不少于3个，K8S管理面每个组件副本数不少于3个的Kubernetes集群。</p><h2 id="整体架构" tabindex="-1">整体架构 <a class="header-anchor" href="#整体架构" aria-label="Permalink to &quot;整体架构&quot;">​</a></h2><p><img src="'+p+`" alt="Kubernetes高可用集群整体架构"></p><h2 id="环境信息" tabindex="-1">环境信息 <a class="header-anchor" href="#环境信息" aria-label="Permalink to &quot;环境信息&quot;">​</a></h2><ul><li><p>Master节点：</p><ul><li>192.168.100.13 cnserver20</li><li>192.168.100.14 cnserver21</li><li>192.168.100.15 cnserver22</li></ul></li><li><p>Worker节点：</p><ul><li>192.168.100.10 cnserver17</li><li>192.168.100.11 cnserver18</li><li>192.168.100.12 cnserver19</li></ul></li><li><p>虚拟ip:</p><ul><li>kubernetes-vip：192.168.100.99</li></ul></li></ul><div class="tip custom-block"><p class="custom-block-title">TIP</p><p><code>kubernetes-vip</code>用于Keepalived的虚拟vip配置，与机器在同一网段，使用同一网卡</p></div><h2 id="配置服务器" tabindex="-1">配置服务器 <a class="header-anchor" href="#配置服务器" aria-label="Permalink to &quot;配置服务器&quot;">​</a></h2><h3 id="基础环境配置" tabindex="-1">基础环境配置 <a class="header-anchor" href="#基础环境配置" aria-label="Permalink to &quot;基础环境配置&quot;">​</a></h3><p>参考<a href="./kubernetes-cluster.html#配置服务器">Kubernetes集群-配置服务器</a>。</p><h3 id="配置-etc-hosts" tabindex="-1">配置/etc/hosts <a class="header-anchor" href="#配置-etc-hosts" aria-label="Permalink to &quot;配置/etc/hosts&quot;">​</a></h3><p>配置/etc/hosts非必要操作，该配置是为了便于后续直接通过主机名称/vip名称进行操作，如不配置，后续操作中的域主机名称/vip名称需要替换成相应ip.</p><p>配置方式为在所有节点的<code>/etc/hosts</code>文件中添加节点信息和vip信息：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">192.168.100.10 cnserver17</span></span>
<span class="line"><span style="color:#e1e4e8;">192.168.100.11 cnserver18</span></span>
<span class="line"><span style="color:#e1e4e8;">192.168.100.12 cnserver19</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">192.168.100.13 cnserver20</span></span>
<span class="line"><span style="color:#e1e4e8;">192.168.100.14 cnserver21</span></span>
<span class="line"><span style="color:#e1e4e8;">192.168.100.15 cnserver22</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">192.168.100.99 kubernetes-vip</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">192.168.100.10 cnserver17</span></span>
<span class="line"><span style="color:#24292e;">192.168.100.11 cnserver18</span></span>
<span class="line"><span style="color:#24292e;">192.168.100.12 cnserver19</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">192.168.100.13 cnserver20</span></span>
<span class="line"><span style="color:#24292e;">192.168.100.14 cnserver21</span></span>
<span class="line"><span style="color:#24292e;">192.168.100.15 cnserver22</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">192.168.100.99 kubernetes-vip</span></span></code></pre></div><h2 id="安装keepalived" tabindex="-1">安装Keepalived <a class="header-anchor" href="#安装keepalived" aria-label="Permalink to &quot;安装Keepalived&quot;">​</a></h2><p>Keepalived是一种高可用方案，通过VIP(虚拟IP)和心跳检测来实现高可用。</p><p>Keepalived通常有Master和Backup两个角色，一般情况下有1个master和多个backup.</p><p>Master会绑定VIP到自己网卡上，对外提供服务。</p><p>Master和Backup会定时确定对方状态，当Master不可用的时候，Backup会通知网关，并把VIP绑定到自己的网卡上，实现服务不中断，即为高可用。</p><h3 id="环境信息-1" tabindex="-1">环境信息 <a class="header-anchor" href="#环境信息-1" aria-label="Permalink to &quot;环境信息&quot;">​</a></h3><p>搭建Keepalied的机器(Kubernetes高可用集群的Master节点)：</p><ul><li>192.168.100.13 cnserver20</li><li>192.168.100.14 cnserver21</li><li>192.168.100.15 cnserver22</li></ul><h3 id="keepalived配置文件" tabindex="-1">Keepalived配置文件 <a class="header-anchor" href="#keepalived配置文件" aria-label="Permalink to &quot;Keepalived配置文件&quot;">​</a></h3><p>在每个节点上配置相应的keepalived.conf，见附件<a href="/downloads/cloud-native/kubernetes/installation/keepalived-config.zip">Keepalived配置</a>。</p><p>配置文件中需要修改的有如下部分：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">……</span></span>
<span class="line"><span style="color:#e1e4e8;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#e1e4e8;">  interface em3 # 此处通过ip addr命令根据实际填写，本机ip所在网卡</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">  state BACKUP# 一台节点配置为MASTER，其他节点配置为BACKUP</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">  unicast_src_ip 192.168.100.15  #设置本机内网ip</span></span>
<span class="line"><span style="color:#e1e4e8;">  </span></span>
<span class="line"><span style="color:#e1e4e8;">  #其他两台master ip</span></span>
<span class="line"><span style="color:#e1e4e8;">  unicast_peer {</span></span>
<span class="line"><span style="color:#e1e4e8;">        192.168.100.13</span></span>
<span class="line"><span style="color:#e1e4e8;">        192.168.100.14</span></span>
<span class="line"><span style="color:#e1e4e8;">  }</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">  virtual_ipaddress {</span></span>
<span class="line"><span style="color:#e1e4e8;">    192.168.100.99  # vip 虚拟ip</span></span>
<span class="line"><span style="color:#e1e4e8;">  }</span></span>
<span class="line"><span style="color:#e1e4e8;">……</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">……</span></span>
<span class="line"><span style="color:#24292e;">vrrp_instance VI_1 {</span></span>
<span class="line"><span style="color:#24292e;">  interface em3 # 此处通过ip addr命令根据实际填写，本机ip所在网卡</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">  state BACKUP# 一台节点配置为MASTER，其他节点配置为BACKUP</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">  unicast_src_ip 192.168.100.15  #设置本机内网ip</span></span>
<span class="line"><span style="color:#24292e;">  </span></span>
<span class="line"><span style="color:#24292e;">  #其他两台master ip</span></span>
<span class="line"><span style="color:#24292e;">  unicast_peer {</span></span>
<span class="line"><span style="color:#24292e;">        192.168.100.13</span></span>
<span class="line"><span style="color:#24292e;">        192.168.100.14</span></span>
<span class="line"><span style="color:#24292e;">  }</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">  virtual_ipaddress {</span></span>
<span class="line"><span style="color:#24292e;">    192.168.100.99  # vip 虚拟ip</span></span>
<span class="line"><span style="color:#24292e;">  }</span></span>
<span class="line"><span style="color:#24292e;">……</span></span></code></pre></div><h3 id="容器启动keepalived" tabindex="-1">容器启动Keepalived <a class="header-anchor" href="#容器启动keepalived" aria-label="Permalink to &quot;容器启动Keepalived&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># $keepalivedConfPath: keepalived.conf文件路径</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--name=keepalived</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--cap-add=NET_ADMIN</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--cap-add=NET_BROADCAST</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--cap-add=NET_RAW</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--net=host</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--restart=always</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--volume</span><span style="color:#E1E4E8;"> $keepalivedConfPath</span><span style="color:#9ECBFF;">:/container/service/keepalived/assets/keepalived.conf</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">osixia/keepalived:2.0.20</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--copy-service</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># $keepalivedConfPath: keepalived.conf文件路径</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--name=keepalived</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--cap-add=NET_ADMIN</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--cap-add=NET_BROADCAST</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--cap-add=NET_RAW</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--net=host</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--restart=always</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--volume</span><span style="color:#24292E;"> $keepalivedConfPath</span><span style="color:#032F62;">:/container/service/keepalived/assets/keepalived.conf</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">osixia/keepalived:2.0.20</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--copy-service</span></span></code></pre></div><h2 id="安装haproxy" tabindex="-1">安装HAProxy <a class="header-anchor" href="#安装haproxy" aria-label="Permalink to &quot;安装HAProxy&quot;">​</a></h2><p>HAProxy 是一款提供高可用性、负载均衡以及基于TCP（第四层）和HTTP（第七层）应用的代理软件。</p><p>HAProxy作为负载均衡时，可以按照指定策略（比如轮询）将流量转发到相应服务中。</p><p>例如当前Server有三个副本由HAProxy进行负载均衡，HAProxy可将客户端对Server的访问请求路由到这三个副本中的一个。这样做有以下好处：</p><ul><li>避免所有请求集中转发到某个server，有效降低单个服务组件的压力;</li><li>当某个server副本宕机，HAProxy可将流量转发到健康的server端，从而保证服务的高可用。</li></ul><h3 id="环境信息-2" tabindex="-1">环境信息 <a class="header-anchor" href="#环境信息-2" aria-label="Permalink to &quot;环境信息&quot;">​</a></h3><p>搭建HAProxy的机器(Kubernetes高可用集群的Master节点)：</p><ul><li>192.168.100.13 cnserver20</li><li>192.168.100.14 cnserver21</li><li>192.168.100.15 cnserver22</li></ul><h3 id="haproxy配置文件" tabindex="-1">HAProxy配置文件 <a class="header-anchor" href="#haproxy配置文件" aria-label="Permalink to &quot;HAProxy配置文件&quot;">​</a></h3><p>在每个节点上配置<code>haproxy.cfg</code>，见附件<a href="/downloads/cloud-native/kubernetes/installation/haproxy.cfg">HAProxy配置</a>。</p><p>其中，主要的负载相关配置如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">……</span></span>
<span class="line"><span style="color:#e1e4e8;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;"># main frontend which proxys to the backends</span></span>
<span class="line"><span style="color:#e1e4e8;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">frontend  kubernetes-apiserver</span></span>
<span class="line"><span style="color:#e1e4e8;">    mode tcp</span></span>
<span class="line"><span style="color:#e1e4e8;">    bind *:9443  ## 监听9443端口</span></span>
<span class="line"><span style="color:#e1e4e8;">    # bind *:443 ssl # To be completed ....</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span></span>
<span class="line"><span style="color:#e1e4e8;">    acl url_static       path_end       -i .jpg .gif .png .css .js</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">    default_backend             kubernetes-apiserver</span></span>
<span class="line"><span style="color:#e1e4e8;"></span></span>
<span class="line"><span style="color:#e1e4e8;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;"># round robin balancing between the various backends</span></span>
<span class="line"><span style="color:#e1e4e8;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">backend kubernetes-apiserver</span></span>
<span class="line"><span style="color:#e1e4e8;">    mode        tcp  # 模式tcp</span></span>
<span class="line"><span style="color:#e1e4e8;">    balance     roundrobin  # 采用轮询的负载算法</span></span>
<span class="line"><span style="color:#e1e4e8;"># k8s-apiservers backend  # 配置apiserver，端口6443</span></span>
<span class="line"><span style="color:#e1e4e8;"> server cnserver20 192.168.100.13:6443 check</span></span>
<span class="line"><span style="color:#e1e4e8;"> server cnserver21 192.168.100.14:6443 check</span></span>
<span class="line"><span style="color:#e1e4e8;"> server cnserver22 192.168.100.15:6443 check</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">……</span></span>
<span class="line"><span style="color:#24292e;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;"># main frontend which proxys to the backends</span></span>
<span class="line"><span style="color:#24292e;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">frontend  kubernetes-apiserver</span></span>
<span class="line"><span style="color:#24292e;">    mode tcp</span></span>
<span class="line"><span style="color:#24292e;">    bind *:9443  ## 监听9443端口</span></span>
<span class="line"><span style="color:#24292e;">    # bind *:443 ssl # To be completed ....</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span></span>
<span class="line"><span style="color:#24292e;">    acl url_static       path_end       -i .jpg .gif .png .css .js</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">    default_backend             kubernetes-apiserver</span></span>
<span class="line"><span style="color:#24292e;"></span></span>
<span class="line"><span style="color:#24292e;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;"># round robin balancing between the various backends</span></span>
<span class="line"><span style="color:#24292e;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">backend kubernetes-apiserver</span></span>
<span class="line"><span style="color:#24292e;">    mode        tcp  # 模式tcp</span></span>
<span class="line"><span style="color:#24292e;">    balance     roundrobin  # 采用轮询的负载算法</span></span>
<span class="line"><span style="color:#24292e;"># k8s-apiservers backend  # 配置apiserver，端口6443</span></span>
<span class="line"><span style="color:#24292e;"> server cnserver20 192.168.100.13:6443 check</span></span>
<span class="line"><span style="color:#24292e;"> server cnserver21 192.168.100.14:6443 check</span></span>
<span class="line"><span style="color:#24292e;"> server cnserver22 192.168.100.15:6443 check</span></span></code></pre></div><h3 id="准备socket文件" tabindex="-1">准备socket文件 <a class="header-anchor" href="#准备socket文件" aria-label="Permalink to &quot;准备socket文件&quot;">​</a></h3><p>准备一个空的文件夹路径<code>$statsDirPath</code>用于haproxy持久化stats文件。</p><h3 id="容器启动haproxy" tabindex="-1">容器启动HAProxy <a class="header-anchor" href="#容器启动haproxy" aria-label="Permalink to &quot;容器启动HAProxy&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#6A737D;"># $haproxyConfDirPath: haproxy.conf文件所在文件夹路径</span></span>
<span class="line"><span style="color:#6A737D;"># $statsDirPath: 用于haproxy持久化stats文件的文件夹路径</span></span>
<span class="line"><span style="color:#B392F0;">docker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--name=haproxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--net=host</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--restart=always</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--volume</span><span style="color:#E1E4E8;"> $haproxyConfDirPath</span><span style="color:#9ECBFF;">:/usr/local/etc/haproxy:ro</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">--volume</span><span style="color:#E1E4E8;"> $statsDirPath</span><span style="color:#9ECBFF;">:/var/lib/haproxy</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">    </span><span style="color:#79B8FF;">-d</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">haproxy:2.3.6</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6A737D;"># $haproxyConfDirPath: haproxy.conf文件所在文件夹路径</span></span>
<span class="line"><span style="color:#6A737D;"># $statsDirPath: 用于haproxy持久化stats文件的文件夹路径</span></span>
<span class="line"><span style="color:#6F42C1;">docker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--name=haproxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--net=host</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--restart=always</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--volume</span><span style="color:#24292E;"> $haproxyConfDirPath</span><span style="color:#032F62;">:/usr/local/etc/haproxy:ro</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">--volume</span><span style="color:#24292E;"> $statsDirPath</span><span style="color:#032F62;">:/var/lib/haproxy</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">    </span><span style="color:#005CC5;">-d</span><span style="color:#24292E;"> </span><span style="color:#032F62;">haproxy:2.3.6</span></span></code></pre></div><h3 id="查看haproxy监控" tabindex="-1">查看HAProxy监控 <a class="header-anchor" href="#查看haproxy监控" aria-label="Permalink to &quot;查看HAProxy监控&quot;">​</a></h3><p>在配置文件<code>haproxy.cfg</code>中定义了HAProxy的监控配置如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;"># haproxy monitor</span></span>
<span class="line"><span style="color:#e1e4e8;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#e1e4e8;">listen admin_stats</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   enable</span></span>
<span class="line"><span style="color:#e1e4e8;">        bind    *:9445    #监听的ip端口号</span></span>
<span class="line"><span style="color:#e1e4e8;">        mode    http    #开关</span></span>
<span class="line"><span style="color:#e1e4e8;">        option  httplog</span></span>
<span class="line"><span style="color:#e1e4e8;">        log     global</span></span>
<span class="line"><span style="color:#e1e4e8;">        maxconn 10</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   refresh 30s   #统计页面自动刷新时间</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   uri /haproxy#访问的uri   ip:9445/haproxy</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   realm haproxy</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   auth admin:admin  #认证用户名和密码</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   hide-version   #隐藏HAProxy的版本号</span></span>
<span class="line"><span style="color:#e1e4e8;">        stats   admin if TRUE   #管理界面，如果认证成功了，可通过webui管理节点</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;"># haproxy monitor</span></span>
<span class="line"><span style="color:#24292e;">#---------------------------------------------------------------------</span></span>
<span class="line"><span style="color:#24292e;">listen admin_stats</span></span>
<span class="line"><span style="color:#24292e;">        stats   enable</span></span>
<span class="line"><span style="color:#24292e;">        bind    *:9445    #监听的ip端口号</span></span>
<span class="line"><span style="color:#24292e;">        mode    http    #开关</span></span>
<span class="line"><span style="color:#24292e;">        option  httplog</span></span>
<span class="line"><span style="color:#24292e;">        log     global</span></span>
<span class="line"><span style="color:#24292e;">        maxconn 10</span></span>
<span class="line"><span style="color:#24292e;">        stats   refresh 30s   #统计页面自动刷新时间</span></span>
<span class="line"><span style="color:#24292e;">        stats   uri /haproxy#访问的uri   ip:9445/haproxy</span></span>
<span class="line"><span style="color:#24292e;">        stats   realm haproxy</span></span>
<span class="line"><span style="color:#24292e;">        stats   auth admin:admin  #认证用户名和密码</span></span>
<span class="line"><span style="color:#24292e;">        stats   hide-version   #隐藏HAProxy的版本号</span></span>
<span class="line"><span style="color:#24292e;">        stats   admin if TRUE   #管理界面，如果认证成功了，可通过webui管理节点</span></span></code></pre></div><p>容器启动之后可以在web上访问来查看haproxy的监控信息，访问地址如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;"># $ip: 由于容器启动命令中制定了--net=host，因此此处的$ip指HAProxy运行的主机的ip</span></span>
<span class="line"><span style="color:#e1e4e8;"># 登录用户名密码为配置中的\`stats auth\`指定，均为admin</span></span>
<span class="line"><span style="color:#e1e4e8;">http://$ip:9445/haproxy</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;"># $ip: 由于容器启动命令中制定了--net=host，因此此处的$ip指HAProxy运行的主机的ip</span></span>
<span class="line"><span style="color:#24292e;"># 登录用户名密码为配置中的\`stats auth\`指定，均为admin</span></span>
<span class="line"><span style="color:#24292e;">http://$ip:9445/haproxy</span></span></code></pre></div><h2 id="安装master节点" tabindex="-1">安装Master节点 <a class="header-anchor" href="#安装master节点" aria-label="Permalink to &quot;安装Master节点&quot;">​</a></h2><p>此处选择先安装Master节点<code>192.168.100.13 cnserver20</code>，从而完成高可用Kubernetes集群的初始化。</p><h3 id="准备kubeadm配置文件" tabindex="-1">准备Kubeadm配置文件 <a class="header-anchor" href="#准备kubeadm配置文件" aria-label="Permalink to &quot;准备Kubeadm配置文件&quot;">​</a></h3><p>Kubeadm的配置文件<code>kubeadm.yaml</code>内容如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">apiVersion: kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="color:#e1e4e8;">kind: ClusterConfiguration</span></span>
<span class="line"><span style="color:#e1e4e8;">kubernetesVersion: v1.23.1</span></span>
<span class="line"><span style="color:#e1e4e8;">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span>
<span class="line"><span style="color:#e1e4e8;">controlPlaneEndpoint: &quot;kubernetes-vip:9443&quot;</span></span>
<span class="line"><span style="color:#e1e4e8;">networking:</span></span>
<span class="line"><span style="color:#e1e4e8;">  dnsDomain: cluster.local</span></span>
<span class="line"><span style="color:#e1e4e8;">  podSubnet: 10.244.0.0/16</span></span>
<span class="line"><span style="color:#e1e4e8;">  serviceSubnet: 10.211.0.0/12</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">apiVersion: kubeadm.k8s.io/v1beta2</span></span>
<span class="line"><span style="color:#24292e;">kind: ClusterConfiguration</span></span>
<span class="line"><span style="color:#24292e;">kubernetesVersion: v1.23.1</span></span>
<span class="line"><span style="color:#24292e;">imageRepository: registry.cn-hangzhou.aliyuncs.com/google_containers</span></span>
<span class="line"><span style="color:#24292e;">controlPlaneEndpoint: &quot;kubernetes-vip:9443&quot;</span></span>
<span class="line"><span style="color:#24292e;">networking:</span></span>
<span class="line"><span style="color:#24292e;">  dnsDomain: cluster.local</span></span>
<span class="line"><span style="color:#24292e;">  podSubnet: 10.244.0.0/16</span></span>
<span class="line"><span style="color:#24292e;">  serviceSubnet: 10.211.0.0/12</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><ul><li><code>kubernetes-vip</code>为<code>/etc/hosts</code>文件中配置Keepalived虚拟IP域名，详见<a href="#配置etchosts">配置/etc/hosts</a>.</li><li>此处使用<code>Flannel</code>作为网络组件,对应的&quot;podSubnet&quot;为<code>10.244.0.0/16</code>；</li><li>若使用<code>Calico</code>作为网络组件,对应的&quot;podSubnet&quot;为<code>192.168.0.0/16</code>.</li></ul></div><h3 id="执行初始化指令" tabindex="-1">执行初始化指令 <a class="header-anchor" href="#执行初始化指令" aria-label="Permalink to &quot;执行初始化指令&quot;">​</a></h3><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">init</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--config</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubeadm.yaml</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--upload-certs</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">init</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--config</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubeadm.yaml</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--upload-certs</span></span></code></pre></div><div class="warning custom-block"><p class="custom-block-title">WARNING</p><p>如果此前执行过以上脚本或者<code>Kubeadm</code>安装指令，则应在执行以上脚本之前执行以下命令：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reset</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reset</span></span></code></pre></div></div><p>初始化完成后，将打印如下消息：</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">Your</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">Kubernetes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">has</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">initialized</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">successfully!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">To</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">start</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">using</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">your</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">need</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">regular</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">mkdir</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-p</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-i</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">sudo</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">chown</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-u</span><span style="color:#9ECBFF;">):$(</span><span style="color:#B392F0;">id</span><span style="color:#9ECBFF;"> </span><span style="color:#79B8FF;">-g</span><span style="color:#9ECBFF;">)</span><span style="color:#E1E4E8;"> $HOME</span><span style="color:#9ECBFF;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Alternatively,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">if</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">are</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">user,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#F97583;">export</span><span style="color:#E1E4E8;"> KUBECONFIG</span><span style="color:#F97583;">=</span><span style="color:#9ECBFF;">/etc/kubernetes/admin.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">You</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">should</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deploy</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pod</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">network</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster.</span></span>
<span class="line"><span style="color:#B392F0;">Run</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">&quot;kubectl apply -f [podnetwork].yaml&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">with</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">one</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">options</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">listed</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">at:</span></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">You</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">now</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">number</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">node</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">command</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">each</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#E1E4E8;">  </span><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes-vip:9443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">grv9o6.75venx9x7sajjowp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">--discovery-token-ca-cert-hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sha256:ea92e650eed7e5df76ab99ac545f61713d3f1ff9001a3281a1f5c71ece7309a5</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">--control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--certificate-key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">e610197e25fbb02e695db6124f21874ff865044cd17b2a3fe5ca73b0d8a791c</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Please</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">note</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">that</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certificate-key</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">gives</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">access</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">cluster</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sensitive</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">data,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">keep</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">it</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">secret!</span></span>
<span class="line"><span style="color:#B392F0;">As</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">a</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">safeguard,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">uploaded-certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">will</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">be</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">deleted</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">in</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">two</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">hours</span><span style="color:#E1E4E8;">; </span><span style="color:#B392F0;">If</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">necessary,</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">use</span></span>
<span class="line"><span style="color:#B392F0;">&quot;kubeadm init phase upload-certs --upload-certs&quot;</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">to</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">reload</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">certs</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">afterward.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">Then</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">you</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">can</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">any</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">number</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">of</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">worker</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">nodes</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">by</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">running</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">the</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">following</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">on</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">each</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">as</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes-vip:9443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">grv9o6.75venx9x7sajjowp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">--discovery-token-ca-cert-hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sha256:ea92e650eed7e5df76ab99ac545f61713d3f1ff9001a3281a1f5c71ece7309a5</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">Your</span><span style="color:#24292E;"> </span><span style="color:#032F62;">Kubernetes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">control-plane</span><span style="color:#24292E;"> </span><span style="color:#032F62;">has</span><span style="color:#24292E;"> </span><span style="color:#032F62;">initialized</span><span style="color:#24292E;"> </span><span style="color:#032F62;">successfully!</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">To</span><span style="color:#24292E;"> </span><span style="color:#032F62;">start</span><span style="color:#24292E;"> </span><span style="color:#032F62;">using</span><span style="color:#24292E;"> </span><span style="color:#032F62;">your</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">need</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">regular</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">mkdir</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-p</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-i</span><span style="color:#24292E;"> </span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">sudo</span><span style="color:#24292E;"> </span><span style="color:#032F62;">chown</span><span style="color:#24292E;"> </span><span style="color:#032F62;">$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-u</span><span style="color:#032F62;">):$(</span><span style="color:#6F42C1;">id</span><span style="color:#032F62;"> </span><span style="color:#005CC5;">-g</span><span style="color:#032F62;">)</span><span style="color:#24292E;"> $HOME</span><span style="color:#032F62;">/.kube/config</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Alternatively,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">if</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">are</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root</span><span style="color:#24292E;"> </span><span style="color:#032F62;">user,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">run:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#D73A49;">export</span><span style="color:#24292E;"> KUBECONFIG</span><span style="color:#D73A49;">=</span><span style="color:#032F62;">/etc/kubernetes/admin.conf</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">You</span><span style="color:#24292E;"> </span><span style="color:#032F62;">should</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deploy</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pod</span><span style="color:#24292E;"> </span><span style="color:#032F62;">network</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster.</span></span>
<span class="line"><span style="color:#6F42C1;">Run</span><span style="color:#24292E;"> </span><span style="color:#032F62;">&quot;kubectl apply -f [podnetwork].yaml&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">with</span><span style="color:#24292E;"> </span><span style="color:#032F62;">one</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">options</span><span style="color:#24292E;"> </span><span style="color:#032F62;">listed</span><span style="color:#24292E;"> </span><span style="color:#032F62;">at:</span></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">https://kubernetes.io/docs/concepts/cluster-administration/addons/</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">You</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">now</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">any</span><span style="color:#24292E;"> </span><span style="color:#032F62;">number</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">control-plane</span><span style="color:#24292E;"> </span><span style="color:#032F62;">node</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">command</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">each</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#24292E;">  </span><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-vip:9443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#032F62;">grv9o6.75venx9x7sajjowp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">--discovery-token-ca-cert-hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sha256:ea92e650eed7e5df76ab99ac545f61713d3f1ff9001a3281a1f5c71ece7309a5</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">--control-plane</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--certificate-key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">e610197e25fbb02e695db6124f21874ff865044cd17b2a3fe5ca73b0d8a791c</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Please</span><span style="color:#24292E;"> </span><span style="color:#032F62;">note</span><span style="color:#24292E;"> </span><span style="color:#032F62;">that</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certificate-key</span><span style="color:#24292E;"> </span><span style="color:#032F62;">gives</span><span style="color:#24292E;"> </span><span style="color:#032F62;">access</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">cluster</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sensitive</span><span style="color:#24292E;"> </span><span style="color:#032F62;">data,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">keep</span><span style="color:#24292E;"> </span><span style="color:#032F62;">it</span><span style="color:#24292E;"> </span><span style="color:#032F62;">secret!</span></span>
<span class="line"><span style="color:#6F42C1;">As</span><span style="color:#24292E;"> </span><span style="color:#032F62;">a</span><span style="color:#24292E;"> </span><span style="color:#032F62;">safeguard,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">uploaded-certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">will</span><span style="color:#24292E;"> </span><span style="color:#032F62;">be</span><span style="color:#24292E;"> </span><span style="color:#032F62;">deleted</span><span style="color:#24292E;"> </span><span style="color:#032F62;">in</span><span style="color:#24292E;"> </span><span style="color:#032F62;">two</span><span style="color:#24292E;"> </span><span style="color:#032F62;">hours</span><span style="color:#24292E;">; </span><span style="color:#6F42C1;">If</span><span style="color:#24292E;"> </span><span style="color:#032F62;">necessary,</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">use</span></span>
<span class="line"><span style="color:#6F42C1;">&quot;kubeadm init phase upload-certs --upload-certs&quot;</span><span style="color:#24292E;"> </span><span style="color:#032F62;">to</span><span style="color:#24292E;"> </span><span style="color:#032F62;">reload</span><span style="color:#24292E;"> </span><span style="color:#032F62;">certs</span><span style="color:#24292E;"> </span><span style="color:#032F62;">afterward.</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">Then</span><span style="color:#24292E;"> </span><span style="color:#032F62;">you</span><span style="color:#24292E;"> </span><span style="color:#032F62;">can</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">any</span><span style="color:#24292E;"> </span><span style="color:#032F62;">number</span><span style="color:#24292E;"> </span><span style="color:#032F62;">of</span><span style="color:#24292E;"> </span><span style="color:#032F62;">worker</span><span style="color:#24292E;"> </span><span style="color:#032F62;">nodes</span><span style="color:#24292E;"> </span><span style="color:#032F62;">by</span><span style="color:#24292E;"> </span><span style="color:#032F62;">running</span><span style="color:#24292E;"> </span><span style="color:#032F62;">the</span><span style="color:#24292E;"> </span><span style="color:#032F62;">following</span><span style="color:#24292E;"> </span><span style="color:#032F62;">on</span><span style="color:#24292E;"> </span><span style="color:#032F62;">each</span><span style="color:#24292E;"> </span><span style="color:#032F62;">as</span><span style="color:#24292E;"> </span><span style="color:#032F62;">root:</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-vip:9443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#032F62;">grv9o6.75venx9x7sajjowp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">        </span><span style="color:#005CC5;">--discovery-token-ca-cert-hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sha256:ea92e650eed7e5df76ab99ac545f61713d3f1ff9001a3281a1f5c71ece7309a5</span></span></code></pre></div><h3 id="配置kubeconfig" tabindex="-1">配置Kubeconfig <a class="header-anchor" href="#配置kubeconfig" aria-label="Permalink to &quot;配置Kubeconfig&quot;">​</a></h3><p>参考<a href="./kubernetes-cluster.html#配置kubeconfig">Kubernetes集群-配置Kubeconfig</a>.</p><h3 id="安装kubernetes网络组件" tabindex="-1">安装Kubernetes网络组件 <a class="header-anchor" href="#安装kubernetes网络组件" aria-label="Permalink to &quot;安装Kubernetes网络组件&quot;">​</a></h3><p>参考<a href="./kubernetes-cluster.html#安装kubernetes网络组件">Kubernetes集群-安装Kubernetes网络组件</a>。</p><h2 id="查看集群信息" tabindex="-1">查看集群信息 <a class="header-anchor" href="#查看集群信息" aria-label="Permalink to &quot;查看集群信息&quot;">​</a></h2><p>参考<a href="./kubernetes-cluster.html#查看集群信息">Kubernetes集群-查看集群信息</a>。</p><h2 id="添加master节点" tabindex="-1">添加Master节点 <a class="header-anchor" href="#添加master节点" aria-label="Permalink to &quot;添加Master节点&quot;">​</a></h2><p>集群初始化完成后打印出的信息中含有<code>--control-plane</code>参数的指令可用于添加<code>Master</code>节点。</p><p>在需要作为Master节点添加到集群中的节点上执行:</p><div class="language-bash vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">bash</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubeadm</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">join</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kubernetes-vip:9443</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--token</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">grv9o6.75venx9x7sajjowp</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">--discovery-token-ca-cert-hash</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">sha256:ea92e650eed7e5df76ab99ac545f61713d3f1ff9001a3281a1f5c71ece7309a5</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">\\</span></span>
<span class="line"><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">--control-plane</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">--certificate-key</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">1</span><span style="color:#9ECBFF;">e610197e25fbb02e695db6124f21874ff865044cd17b2a3fe5ca73b0d8a791c</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubeadm</span><span style="color:#24292E;"> </span><span style="color:#032F62;">join</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kubernetes-vip:9443</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--token</span><span style="color:#24292E;"> </span><span style="color:#032F62;">grv9o6.75venx9x7sajjowp</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">--discovery-token-ca-cert-hash</span><span style="color:#24292E;"> </span><span style="color:#032F62;">sha256:ea92e650eed7e5df76ab99ac545f61713d3f1ff9001a3281a1f5c71ece7309a5</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">\\</span></span>
<span class="line"><span style="color:#24292E;">      </span><span style="color:#005CC5;">--control-plane</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">--certificate-key</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">1</span><span style="color:#032F62;">e610197e25fbb02e695db6124f21874ff865044cd17b2a3fe5ca73b0d8a791c</span></span></code></pre></div><div class="tip custom-block"><p class="custom-block-title">TIP</p><ul><li>Kubeadm更多参数参考<a href="/zh/tools/kubeadm.html#参数">Kubeadm参数</a>;</li><li>若Token已过期，参考<a href="./../installation.html#重新生成增加节点的token">重新生成增加节点的Token</a>;</li><li>若Certificate已过期，参考<a href="./../installation.html#重新生成增加节点的certificate">重新生成增加节点的Certificate</a>;</li><li>添加Master节点之后，亦需要配置<code>Kubeconfig</code>，参考<a href="./../installation.html#配置kubeconfig">配置Kubeconfig</a>.</li></ul></div><h2 id="添加worker节点" tabindex="-1">添加Worker节点 <a class="header-anchor" href="#添加worker节点" aria-label="Permalink to &quot;添加Worker节点&quot;">​</a></h2><p>集群初始化完成后打印出的信息中不含有<code>--control-plane</code>参数的指令可用于添加<code>Worker</code>节点。</p><p>参考<a href="./kubernetes-cluster.html#添加worker节点">Kubernetes集群-添加Worker节点</a>。</p><h2 id="卸载kubernetes集群" tabindex="-1">卸载Kubernetes集群 <a class="header-anchor" href="#卸载kubernetes集群" aria-label="Permalink to &quot;卸载Kubernetes集群&quot;">​</a></h2><p>参考<a href="./kubernetes-cluster.html#卸载kubernetes集群">Kubernetes集群-卸载Kubernetes集群</a>。</p>`,76),c=[o];function t(r,y,i,E,F,d){return a(),n("div",null,c)}const C=s(e,[["render",t]]);export{h as __pageData,C as default};
