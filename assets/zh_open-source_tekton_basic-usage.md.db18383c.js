import{_ as s,o as n,c as a,Q as l}from"./chunks/framework.48927342.js";const p="/images/open-source/tekton/tekton-concept.png",d=JSON.parse('{"title":"Tekton基本使用","description":"","frontmatter":{"date":"2022-10-30T00:00:00.000Z","tag":["Tekton"],"tags":["Kubernetes"],"categories":["DevOps"]},"headers":[],"relativePath":"zh/open-source/tekton/basic-usage.md","filePath":"zh/open-source/tekton/basic-usage.md"}'),o={name:"zh/open-source/tekton/basic-usage.md"},e=l('<h1 id="tekton基本使用" tabindex="-1">Tekton基本使用 <a class="header-anchor" href="#tekton基本使用" aria-label="Permalink to &quot;Tekton基本使用&quot;">​</a></h1><h2 id="概览" tabindex="-1">概览 <a class="header-anchor" href="#概览" aria-label="Permalink to &quot;概览&quot;">​</a></h2><p>Tekton 是用于构建 CI/CD 的云原生解决方案，主要在 Kubernetes 集群上的安装和运行。开发者可以通过Tekton来定义自己的CI流程，从而实现从项目构建到项目发布的全流程。</p><p>Tekton定义了一组 CR(Kubernetes 自定义资源)，用户通过这些CR来定义自己的CI流程，Tekton的管理组件通过解析用户定义的CR来执行整个CI流程。</p><h2 id="概念介绍" tabindex="-1">概念介绍 <a class="header-anchor" href="#概念介绍" aria-label="Permalink to &quot;概念介绍&quot;">​</a></h2><p>Tekton常用的基本概念如下，他们的关系如图所示：</p><ul><li>Step：步骤。步骤是整个CI/CD流程的最小单元，比如拉取代码、编译程序都可以是独立的一个步骤；</li><li>Task：任务。任务是按顺序排列的Step的集合，每个Task在一个Pod中执行；</li><li>TaskRun：TaskRun是Task的特定执行。可以通过TaskRun资源执行指定Task并查看执行情况;</li><li>Pipeline：管道。管道按顺序排列的Task的集合，可以在Pipeline中定义Task的执行顺序和执行条件；</li><li>PipelineRun：PipelineRun是Pipeline的特定执行。可以通过PipelineRun资源执行指定Pipeline并查看执行情况。</li></ul><p><img src="'+p+`" alt="Tekton常用概念"></p><p>其中，Task，TaskRun, Pipeline和PipelineRun为自定义资源。 PipelineResources资源在v0.30.0版本已启用，此处不做介绍。</p><h2 id="tekton使用示例" tabindex="-1">Tekton使用示例 <a class="header-anchor" href="#tekton使用示例" aria-label="Permalink to &quot;Tekton使用示例&quot;">​</a></h2><p>当前在Gitlab上有一个名为tekton项目，项目内容为<a href="/downloads/open-source/tektontekton-master.zip">tekton-master.zip</a></p><p>这个项目的CI/CD流程如下：</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#e1e4e8;">从Gitlab拉取代码  &gt;&gt; 构建Docker镜像 &gt;&gt; 推送Docker镜像到Harbor镜像仓库</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#24292e;">从Gitlab拉取代码  &gt;&gt; 构建Docker镜像 &gt;&gt; 推送Docker镜像到Harbor镜像仓库</span></span></code></pre></div><p>以下将介绍如何使用Tekton实现上述CI/CD流程。</p><h3 id="准备资源文件" tabindex="-1">准备资源文件 <a class="header-anchor" href="#准备资源文件" aria-label="Permalink to &quot;准备资源文件&quot;">​</a></h3><p><a href="/downloads/open-source/tekton/tekton-cicd.zip">tekton-cicd.zip</a></p><p>以上zip包中包含以下文件：</p><ul><li>git-clone-task.yaml：用于拉取Gitlab代码的Task资源文件，为通用模板文件，将Gitlab仓库地址、分支等参数暴露出来；</li><li>kaniko-task.yaml：用于构建并推送Docker镜像的Task资源文件，为通用模板文件，将Docker镜像名称、Tag等参数暴露出来；</li><li>pipeline.yaml：CI/CD的流程文件，组合了拉取代码和构建镜像的Task，指定传入Task的参数，并将传入参数暴露出来，从而可以在执行pipeline时指定;</li><li>pipelinerun.yaml：pipeline的执行资源文件，用于执行pipeline使用，并指定pipeline的执行参数，比如Gitlab仓库地址和分支、Docker镜像名称和Tag等；</li><li>harbor-auth.yaml：用于推送Docker镜像到Harbor镜像仓库的身份认证；</li><li>pipeline在执行CI/CD流程的时候，Gitlab仓库地址和分支、Docker镜像名称和Tag等参数可以在pipelinerun的资源文件中进行指定；</li><li>pipeline.yaml中的runAfter字段可以定义task在某些其他task完成之后再开始执行；</li></ul><p>常用的通用Task文件可参考：<a href="https://github.com/tektoncd/catalog/tree/main/task" target="_blank" rel="noreferrer">tektoncd/catalog/task/</a></p><h3 id="部署资源文件" tabindex="-1">部署资源文件 <a class="header-anchor" href="#部署资源文件" aria-label="Permalink to &quot;部署资源文件&quot;">​</a></h3><ol><li><p>执行以下指令,部署基础资源文件：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ntekton-pipelines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">git-clone-task.yaml</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ntekton-pipelines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">kaniko-task.yaml</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ntekton-pipelines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">harbor-auth.yaml</span></span>
<span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ntekton-pipelines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pipeline.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ntekton-pipelines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">git-clone-task.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ntekton-pipelines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">kaniko-task.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ntekton-pipelines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">harbor-auth.yaml</span></span>
<span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ntekton-pipelines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pipeline.yaml</span></span></code></pre></div></li><li><p>执行以下指令，触发该CI流程：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ntekton-pipelines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">apply</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-f</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">pipelinerun.yaml</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ntekton-pipelines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">apply</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-f</span><span style="color:#24292E;"> </span><span style="color:#032F62;">pipelinerun.yaml</span></span></code></pre></div></li></ol><h3 id="查看相关资源" tabindex="-1">查看相关资源 <a class="header-anchor" href="#查看相关资源" aria-label="Permalink to &quot;查看相关资源&quot;">​</a></h3><p>执行以下指令，查看流水线相关资源：</p><div class="language-sh vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki github-dark vp-code-dark"><code><span class="line"><span style="color:#B392F0;">kubectl</span><span style="color:#E1E4E8;"> </span><span style="color:#79B8FF;">-ntekton-pipelines</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">get</span><span style="color:#E1E4E8;"> </span><span style="color:#9ECBFF;">task,pipeline,pipelinerun,secret,taskrun</span></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                        </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">task.tekton.dev/git-clone</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m12s</span></span>
<span class="line"><span style="color:#B392F0;">task.tekton.dev/kaniko</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m12s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">pipeline.tekton.dev/test-pipeline</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m12s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                       </span><span style="color:#9ECBFF;">SUCCEEDED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">REASON</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">STARTTIME</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">COMPLETIONTIME</span></span>
<span class="line"><span style="color:#B392F0;">pipelinerun.tekton.dev/test-pipeline-run</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">True</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">Succeeded</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">109</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                             </span><span style="color:#9ECBFF;">TYPE</span><span style="color:#E1E4E8;">                                  </span><span style="color:#9ECBFF;">DATA</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">AGE</span></span>
<span class="line"><span style="color:#B392F0;">……</span></span>
<span class="line"><span style="color:#B392F0;">secret/harbor-auth</span><span style="color:#E1E4E8;">                               </span><span style="color:#9ECBFF;">kubernetes.io/dockerconfigjson</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">1</span><span style="color:#E1E4E8;">      </span><span style="color:#79B8FF;">2</span><span style="color:#9ECBFF;">m12s</span></span>
<span class="line"><span style="color:#B392F0;">……</span></span>
<span class="line"></span>
<span class="line"><span style="color:#B392F0;">NAME</span><span style="color:#E1E4E8;">                                                  </span><span style="color:#9ECBFF;">SUCCEEDED</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">REASON</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">STARTTIME</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">COMPLETIONTIME</span></span>
<span class="line"><span style="color:#B392F0;">taskrun.tekton.dev/test-pipeline-run-build-image</span><span style="color:#E1E4E8;">      </span><span style="color:#9ECBFF;">True</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">Succeeded</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">109</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">15</span><span style="color:#9ECBFF;">s</span></span>
<span class="line"><span style="color:#B392F0;">taskrun.tekton.dev/test-pipeline-run-fetch-from-git</span><span style="color:#E1E4E8;">   </span><span style="color:#9ECBFF;">True</span><span style="color:#E1E4E8;">        </span><span style="color:#9ECBFF;">Succeeded</span><span style="color:#E1E4E8;">   </span><span style="color:#79B8FF;">109</span><span style="color:#9ECBFF;">s</span><span style="color:#E1E4E8;">        </span><span style="color:#79B8FF;">101</span><span style="color:#9ECBFF;">s</span></span></code></pre><pre class="shiki github-light vp-code-light"><code><span class="line"><span style="color:#6F42C1;">kubectl</span><span style="color:#24292E;"> </span><span style="color:#005CC5;">-ntekton-pipelines</span><span style="color:#24292E;"> </span><span style="color:#032F62;">get</span><span style="color:#24292E;"> </span><span style="color:#032F62;">task,pipeline,pipelinerun,secret,taskrun</span></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                        </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">task.tekton.dev/git-clone</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m12s</span></span>
<span class="line"><span style="color:#6F42C1;">task.tekton.dev/kaniko</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m12s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">pipeline.tekton.dev/test-pipeline</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m12s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                       </span><span style="color:#032F62;">SUCCEEDED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">REASON</span><span style="color:#24292E;">      </span><span style="color:#032F62;">STARTTIME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">COMPLETIONTIME</span></span>
<span class="line"><span style="color:#6F42C1;">pipelinerun.tekton.dev/test-pipeline-run</span><span style="color:#24292E;">   </span><span style="color:#032F62;">True</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Succeeded</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">109</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">s</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                             </span><span style="color:#032F62;">TYPE</span><span style="color:#24292E;">                                  </span><span style="color:#032F62;">DATA</span><span style="color:#24292E;">   </span><span style="color:#032F62;">AGE</span></span>
<span class="line"><span style="color:#6F42C1;">……</span></span>
<span class="line"><span style="color:#6F42C1;">secret/harbor-auth</span><span style="color:#24292E;">                               </span><span style="color:#032F62;">kubernetes.io/dockerconfigjson</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">1</span><span style="color:#24292E;">      </span><span style="color:#005CC5;">2</span><span style="color:#032F62;">m12s</span></span>
<span class="line"><span style="color:#6F42C1;">……</span></span>
<span class="line"></span>
<span class="line"><span style="color:#6F42C1;">NAME</span><span style="color:#24292E;">                                                  </span><span style="color:#032F62;">SUCCEEDED</span><span style="color:#24292E;">   </span><span style="color:#032F62;">REASON</span><span style="color:#24292E;">      </span><span style="color:#032F62;">STARTTIME</span><span style="color:#24292E;">   </span><span style="color:#032F62;">COMPLETIONTIME</span></span>
<span class="line"><span style="color:#6F42C1;">taskrun.tekton.dev/test-pipeline-run-build-image</span><span style="color:#24292E;">      </span><span style="color:#032F62;">True</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Succeeded</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">109</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">15</span><span style="color:#032F62;">s</span></span>
<span class="line"><span style="color:#6F42C1;">taskrun.tekton.dev/test-pipeline-run-fetch-from-git</span><span style="color:#24292E;">   </span><span style="color:#032F62;">True</span><span style="color:#24292E;">        </span><span style="color:#032F62;">Succeeded</span><span style="color:#24292E;">   </span><span style="color:#005CC5;">109</span><span style="color:#032F62;">s</span><span style="color:#24292E;">        </span><span style="color:#005CC5;">101</span><span style="color:#032F62;">s</span></span></code></pre></div><p>如果你部署了Tekton-Dashboard, 也可以在Tekton-Dashboard的web页面上查看流水线及相关资源。</p>`,25),t=[e];function c(r,i,y,E,F,k){return n(),a("div",null,t)}const u=s(o,[["render",c]]);export{d as __pageData,u as default};
